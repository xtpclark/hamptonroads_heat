<!DOCTYPE html>
<html>
<head>
    <title>Hampton Roads Heat</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #3498db;
            --dark-bg: #34495e;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            overflow: hidden;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
        }
        
        /* LEFT SIDEBAR - Status and Info */
        #left-sidebar {
            width: 20%;
            min-width: 250px;
            background: white;
            padding: 15px;
            overflow-y: auto;
            box-shadow: 5px 0 15px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
        }
        
        /* MAP CONTAINER - Now with direct Leaflet instead of iframe */
        #map-container { 
            height: 100vh; 
            flex: 1;
            border-left: 3px solid var(--primary);
            border-right: 3px solid var(--primary);
            position: relative;
        }
        
        #map { 
            width: 100%; 
            height: 100%; 
        }
        
        /* ACTION LOG SLIDEOUT */
        #log-slideout {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        #log-slideout.open {
            max-height: 400px;
        }
        
        #log-toggle {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1001;
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: all 0.2s;
        }
        
        #log-toggle:hover {
            background: #1a252f;
            transform: translateX(-50%) translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        
        #log-slideout-content {
            padding: 60px 20px 20px;
        }
        
        #log-slideout h3 {
            color: var(--primary);
            margin: 0 0 15px 0;
            font-size: 1.3em;
            text-align: center;
            border-bottom: 3px solid var(--primary);
            padding-bottom: 10px;
        }
        
        #log { 
            height: 280px;
            overflow-y: auto; 
            border: 2px solid var(--info); 
            padding: 15px;
            background: #fafafa;
            border-radius: 5px;
        }
        
        #log p {
            border-left: 4px solid var(--info);
            padding-left: 10px;
            margin: 10px 0;
            animation: slideIn 0.3s ease-out;
            font-size: 0.9em;
            line-height: 1.5;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        /* RIGHT SIDEBAR - Actions */
        #right-sidebar { 
            width: 22%;
            min-width: 280px;
            padding: 15px;
            background: white;
            overflow-y: auto;
            box-shadow: -5px 0 15px rgba(0,0,0,0.2);
        }
        
        h2 {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 1.5em;
            text-align: center;
            border-bottom: 3px solid var(--primary);
            padding-bottom: 10px;
        }
        
        h3 {
            color: var(--dark-bg);
            margin: 15px 0 10px 0;
            font-size: 1.1em;
            border-bottom: 2px solid var(--info);
            padding-bottom: 5px;
        }
        
        select, button { 
            margin: 5px 0; 
            padding: 10px; 
            width: 100%;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 0.95em;
        }
        
        button {
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            background: #1a252f;
        }
        
        button:active:not(:disabled) {
            transform: translateY(0);
        }
        
        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        
        .action-button {
            background: var(--info);
            margin: 8px 0;
            text-align: left;
            padding: 12px;
            font-size: 0.9em;
        }
        
        .action-button:hover:not(:disabled) {
            background: #2980b9;
        }
        
        .action-cost {
            float: right;
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.9em;
        }
        
        .reset-button {
            background-color: var(--danger);
        }
        
        .reset-button:hover {
            background-color: #c0392b;
        }
        
        /* METRICS STYLING */
        #metrics {
            background: linear-gradient(135deg, #ecf0f1 0%, #dfe6e9 100%);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 2px solid var(--primary);
        }
        
        #metrics p {
            margin: 8px 0;
            font-size: 1em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2px 0;
        }
        
        .metric-label {
            font-weight: 600;
            color: var(--dark-bg);
        }
        
        .metric-value {
            transition: all 0.3s ease;
            display: inline-block;
            padding: 3px 12px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 1.1em;
            background: white;
            border: 2px solid #ddd;
            min-width: 60px;
            text-align: right;
        }
        
        .metric-increase {
            animation: flashGreen 0.8s;
        }
        
        .metric-decrease {
            animation: flashRed 0.8s;
        }
        
        @keyframes flashGreen {
            0%, 100% { background-color: white; color: inherit; border-color: #ddd; }
            50% { background-color: rgba(40, 167, 69, 0.5); color: #155724; border-color: var(--success); }
        }
        
        @keyframes flashRed {
            0%, 100% { background-color: white; color: inherit; border-color: #ddd; }
            50% { background-color: rgba(220, 53, 69, 0.5); color: #721c24; border-color: var(--danger); }
        }
        
        .change-indicator {
            font-size: 1em;
            margin-left: 8px;
            font-weight: bold;
            animation: fadeOut 3.5s forwards;
            position: relative;
            display: inline-block;
        }
        
        @keyframes fadeOut {
            0% { opacity: 1; transform: translateY(0) scale(1.2); }
            20% { opacity: 1; transform: translateY(-5px) scale(1.2); }
            100% { opacity: 0; transform: translateY(-15px) scale(1); }
        }
        
        /* WIN PROGRESS */
        #win-progress {
            background: #e8f5e9;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            border: 2px solid var(--success);
        }
        
        #win-progress h4 {
            margin: 0 0 8px 0;
            color: var(--success);
            font-size: 1em;
        }
        
        .progress-bar {
            width: 100%;
            height: 25px;
            background: #ddd;
            border-radius: 12px;
            overflow: hidden;
            margin: 8px 0;
            border: 2px solid var(--success);
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success) 0%, #2ecc71 100%);
            width: 0%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.85em;
        }
        
        /* PULSE EVENTS */
        #pulse-container {
            position: fixed; 
            bottom: 30px; 
            left: 50%;
            transform: translateX(-50%);
            width: 600px;
            z-index: 1000; 
            display: flex; 
            flex-direction: column-reverse; 
            align-items: center;
            pointer-events: none;
        }
        
        .pulse-bubble {
            background-color: #FFFFFF; 
            color: #333; 
            border: 3px solid var(--success);
            padding: 20px 30px; 
            border-radius: 20px; 
            margin-top: 15px;
            width: 100%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
            font-size: 1.1em;
            font-weight: 500;
            animation: floatUp 12s forwards ease-in-out;
            text-align: center;
            pointer-events: auto;
        }
        
        @keyframes floatUp {
            0% { opacity: 0; transform: translateY(0) scale(0.9); }
            10% { opacity: 1; transform: translateY(0) scale(1); }
            90% { opacity: 1; }
            100% { opacity: 0; transform: translateY(-100px) scale(0.95); }
        }
        
        /* MODALS */
        .modal-overlay {
            display: none; 
            position: fixed; 
            z-index: 2000; 
            left: 0; 
            top: 0;
            width: 100%; 
            height: 100%; 
            background-color: rgba(0, 0, 0, 0.8);
            justify-content: center; 
            align-items: center;
        }
        
        .modal-content {
            background-color: #fefefe; 
            padding: 30px; 
            border: 1px solid #888;
            border-radius: 12px; 
            width: 85%; 
            max-width: 650px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            max-height: 85vh;
            overflow-y: auto;
        }
        
        .modal-content h2 {
            margin-top: 0;
            color: var(--primary);
        }
        
        .modal-content h3 {
            color: var(--dark-bg);
            margin-top: 15px;
        }
        
        .modal-content ul, .modal-content ol {
            margin: 10px 0;
            padding-left: 25px;
        }
        
        .modal-content li {
            margin: 8px 0;
            line-height: 1.5;
        }
        
        #game-over-modal .modal-content { 
            text-align: center; 
        }
        
        #event-modal .modal-content { 
            text-align: left; 
        }
        
        #event-choices { 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            margin-top: 20px; 
        }
        
        .tutorial-page {
            min-height: 300px;
        }
        
        #tutorial-page-indicator {
            font-weight: bold;
            color: var(--primary);
            font-size: 1.1em;
        }
        
        #top-crimes-list {
            padding-left: 20px;
            margin-top: 10px;
        }
        
        #top-crimes-list li {
            margin: 5px 0;
            line-height: 1.4;
        }
        
        .view-toggle-group {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        /* HOTSPOT STYLES */
        .hotspot-popup {
            min-width: 250px;
        }
        
        .hotspot-header {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        .hotspot-severity {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.85em;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .severity-critical { background: #e74c3c; color: white; }
        .severity-high { background: #f39c12; color: white; }
        .severity-moderate { background: #f1c40f; color: #333; }
        
        .hotspot-stats {
            margin: 10px 0;
            font-size: 0.9em;
        }
        
        .hotspot-action-btn {
            width: 100%;
            margin: 5px 0;
            padding: 8px;
            background: var(--info);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
        }
        
        .hotspot-action-btn:hover {
            background: #2980b9;
        }
    </style>
</head>
<body>
    <div id="pulse-container"></div>
    
    <!-- LEFT SIDEBAR - Status -->
    <div id="left-sidebar">
        <h2>Status</h2>
        
        <div id="metrics">
            <h3 style="margin-top: 0; border: none; font-size: 1em; text-align: center;">Current Metrics</h3>
            <p>
                <span class="metric-label">Budget:</span>
                <span>$<span id="budget" class="metric-value">100.0</span>M</span>
            </p>
            <p>
                <span class="metric-label">Reputation:</span>
                <span id="reputation" class="metric-value">50.0</span>
            </p>
            <p>
                <span class="metric-label">Backlash:</span>
                <span id="backlash" class="metric-value">0.0</span>%
            </p>
            <p>
                <span class="metric-label">Police Force:</span>
                <span id="police-force" class="metric-value">100.0</span>
            </p>
            <p>
                <span class="metric-label">Funeral Load:</span>
                <span class="metric-value" id="funeral-load" style="min-width: 80px; font-size: 0.9em;">0</span>
            </p>
        </div>
        
        <div id="win-progress">
            <h4>Golden Age Progress</h4>
            <p style="margin: 5px 0;"><strong><span id="stability-turns">0</span>/12 turns</strong></p>
            <div class="progress-bar">
                <div class="progress-fill" id="stability-progress"></div>
            </div>
            <small>Maintain: Rep >80, Backlash <10, Budget >0</small>
        </div>
        
        <div id="top-crimes">
            <h3>Top 5 Incidents</h3>
            <ol id="top-crimes-list"></ol>
        </div>
        
        <label for="locality" style="margin-top: 15px;"><strong>City:</strong></label>
        <select id="locality">
            {% for loc in localities %}
                <option value="{{ loc }}">{{ loc }}</option>
            {% endfor %}
        </select>
        
        <label for="crime-type-filter"><strong>Crime Filter:</strong></label>
        <select id="crime-type-filter">
            <option value="all">All Types</option>
            {% for crime_type in crime_types %}
                <option value="{{ crime_type }}">{{ crime_type | title }}</option>
            {% endfor %}
        </select>
        
        <div class="view-toggle-group">
            <label><strong>Map View:</strong></label><br>
            <input type="radio" id="view-heatmap" name="view_type" value="heatmap" checked> 
            <label for="view-heatmap">Heatmap</label><br>
            <input type="radio" id="view-icon" name="view_type" value="icon"> 
            <label for="view-icon">Icons</label>
        </div>
    </div>
    
    <!-- MAP -->
    <div id="map-container">
        <button id="log-toggle">📋 Action Log</button>
        <div id="log-slideout">
            <div id="log-slideout-content">
                <h3>Action Log</h3>
                <div id="log"></div>
            </div>
        </div>
        <div id="map"></div>
    </div>
    
    <!-- RIGHT SIDEBAR - Actions -->
    <div id="right-sidebar">
        <h2>Actions</h2>
        {% for action in actions %}
            <button class="action-button" onclick="takeAction('{{ action.id }}')" title="{{ action.description }}">
                {{ action.name }}
                <span class="action-cost">${{ action.cost }}M</span>
            </button>
        {% endfor %}
        
        <hr style="margin: 15px 0; border: 1px solid #ddd;">
        <p style="font-size: 0.9em; color: var(--info); font-weight: bold; text-align: center;">
            💡 TIP: Click hotspot circles on map for targeted actions (50% cost!)
        </p>
        <hr style="margin: 15px 0; border: 1px solid #ddd;">
        <button onclick="resetGame()" class="reset-button">Reset Game</button>
    </div>

    <!-- Tutorial Modal -->
    <div id="tutorial-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Welcome to Hampton Roads Heat</h2>
            <div id="tutorial-content">
                <div class="tutorial-page" data-page="1">
                    <h3>Your Mission</h3>
                    <p>You are the Regional Response Director for Norfolk, Virginia. Your job is to balance four competing priorities:</p>
                    <ul>
                        <li><strong>Budget:</strong> Financial resources. Don't go bankrupt.</li>
                        <li><strong>Reputation:</strong> Public trust in your leadership.</li>
                        <li><strong>Backlash:</strong> Social friction and unrest.</li>
                        <li><strong>Police Force:</strong> Officer capacity. Enforcement actions deplete this.</li>
                    </ul>
                    <p><strong>Win Condition:</strong> Maintain Reputation >80, Backlash <10, and positive Budget for 12 consecutive turns.</p>
                    <p><strong>Loss Conditions:</strong> Budget reaches $0 or 10+ homicides in 15 days.</p>
                </div>
                
                <div class="tutorial-page" data-page="2" style="display:none;">
                    <h3>How the Game Works</h3>
                    <p>Each turn:</p>
                    <ol>
                        <li><strong>Simulation runs FIRST</strong> - New crimes occur, events trigger</li>
                        <li><strong>You choose ONE action</strong> - Each has different costs</li>
                        <li><strong>Effects apply</strong> - Crime weights reduced, metrics adjusted</li>
                        <li><strong>Police force regenerates</strong> - +3 per turn automatically</li>
                    </ol>
                    <p><strong>Police Force:</strong> Enforcement actions consume force. If it's too low, aggressive tactics fail.</p>
                </div>
                
                <div class="tutorial-page" data-page="3" style="display:none;">
                    <h3>Strategy & Balance</h3>
                    <p>Balance different approaches:</p>
                    <ul>
                        <li><strong>Enforcement</strong> (Sweeps, Task Forces) - High police force cost, immediate results, damages trust</li>
                        <li><strong>Community</strong> (Policing, Training) - Restores police force, builds trust slowly</li>
                        <li><strong>Prevention</strong> (Youth, Social Services) - Long-term investments</li>
                        <li><strong>Economic</strong> (Business, Infrastructure) - Addresses root causes</li>
                    </ul>
                    <p><em>High backlash increases crime generation!</em></p>
                </div>
                
                <div class="tutorial-page" data-page="4" style="display:none;">
                    <h3>NEW: Interactive Hotspot System</h3>
                    <p><strong>Hotspot Circles:</strong> Colored circles show active crime zones. Click them for targeted actions!</p>
                    <p><strong>Colors:</strong></p>
                    <ul>
                        <li><strong style="color: #e74c3c;">Red</strong> = Critical (needs immediate attention)</li>
                        <li><strong style="color: #f39c12;">Orange</strong> = High priority</li>
                        <li><strong style="color: #f1c40f;">Yellow</strong> = Moderate</li>
                    </ul>
                    <p><strong>Benefits of targeted actions:</strong> Half cost, less political damage, more effective!</p>
                    <p><strong>City-wide vs Targeted:</strong> Use sidebar for city-wide actions, click map for precision strikes.</p>
                    <p style="margin-top: 20px; text-align: center;"><strong>Ready to begin? Good luck, Director!</strong></p>
                </div>
            </div>
            
            <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center;">
                <button id="tutorial-prev" style="width: auto; padding: 10px 20px;">Previous</button>
                <span id="tutorial-page-indicator">1 / 4</span>
                <button id="tutorial-next" style="width: auto; padding: 10px 20px;">Next</button>
                <button id="tutorial-skip" style="width: auto; padding: 10px 20px; background-color: #95a5a6;">Start Game</button>
            </div>
        </div>
    </div>

    <!-- Game Over Modal -->
    <div id="game-over-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="game-over-title">Game Over</h2>
            <p id="game-over-message" style="font-size: 1.1em; margin: 20px 0;"></p>
            <button onclick="window.location.reload();">Play Again</button>
        </div>
    </div>
    
    <!-- Event Modal -->
    <div id="event-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="event-title"></h2>
            <p id="event-text" style="margin: 15px 0; line-height: 1.6;"></p>
            <div id="event-choices"></div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        let map, heatLayer, markerCluster, hotspotLayer;
        let currentMapData = null;
        let prevMetrics = { budget: 100, reputation: 50, backlash: 0, police_force: 100 };
        let stabilityTurns = 0;
        let currentTutorialPage = 1;
        const totalTutorialPages = 4;

        // Tutorial functions
        function changeTutorialPage(direction) {
            currentTutorialPage += direction;
            if (currentTutorialPage < 1) currentTutorialPage = 1;
            if (currentTutorialPage > totalTutorialPages) currentTutorialPage = totalTutorialPages;
            
            $('.tutorial-page').hide();
            $(`.tutorial-page[data-page="${currentTutorialPage}"]`).show();
            $('#tutorial-page-indicator').text(`${currentTutorialPage} / ${totalTutorialPages}`);
            
            $('#tutorial-prev').prop('disabled', currentTutorialPage === 1);
            $('#tutorial-next').prop('disabled', currentTutorialPage === totalTutorialPages);
            
            if (currentTutorialPage === totalTutorialPages) {
                $('#tutorial-next').text('Start Game');
            } else {
                $('#tutorial-next').text('Next');
            }
        }

        function closeTutorial() {
            $('#tutorial-modal').hide();
            localStorage.setItem('tutorial_completed', 'true');
        }

        function showPulseEvent(text) {
            const bubble = $('<div class="pulse-bubble"></div>').text(text);
            $('#pulse-container').append(bubble);
            setTimeout(() => bubble.remove(), 12000);
        }

        // Initialize map
        function initMap() {
            map = L.map('map').setView([36.85, -76.28], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            
            markerCluster = L.markerClusterGroup();
            hotspotLayer = L.layerGroup().addTo(map);
            
            updateMap();
        }

        function updateMap() {
            const locality = $('#locality').val();
            const crimeType = $('#crime-type-filter').val();
            const viewType = $('input[name="view_type"]:checked').val();
            
            $.getJSON(`/${locality}/map_data?crime_type=${crimeType}`, function(data) {
                currentMapData = data;
                renderMap(data, viewType);
                
                // Update top crimes and funeral load
                if (data.top_crimes) {
                    const list = $('#top-crimes-list').empty();
                    if (data.top_crimes.length > 0) {
                        data.top_crimes.forEach(crime => {
                            list.append(`<li>${crime.type.replace(/_/g, ' ').toUpperCase()}: ${crime.count}</li>`);
                        });
                    } else {
                        list.append(`<li>No incidents recorded.</li>`);
                    }
                }
                
                if (data.funeral_load) {
                    let loadText = Object.entries(data.funeral_load)
                        .map(([name, count]) => `${name}: ${count}`)
                        .join(', ');
                    $('#funeral-load').text(loadText || 'None');
                } else {
                    $('#funeral-load').text('None');
                }
            });
        }

        function renderMap(data, viewType) {
            // Clear existing layers
            if (heatLayer) map.removeLayer(heatLayer);
            map.removeLayer(markerCluster);
            markerCluster.clearLayers();
            hotspotLayer.clearLayers();
            
            // Always render hotspots
            renderHotspots(data.hotspots);
            
            // Render incidents based on view type
            if (viewType === 'heatmap' && data.incidents.length > 0) {
                const heatData = data.incidents.map(i => [i.lat, i.lon, i.weight / 10]);
                heatLayer = L.heatLayer(heatData, {
                    radius: 25,
                    blur: 15,
                    maxZoom: 17
                }).addTo(map);
            } else if (viewType === 'icon' && data.incidents.length > 0) {
                const colorMap = {
                    'shooting': 'red', 'homicide': 'black', 'assault': 'darkred',
                    'robbery': 'purple', 'petty_theft': 'orange', 'vandalism': 'yellow',
                    'od': 'blue', 'larceny_auto': 'brown'
                };
                
                data.incidents.forEach(incident => {
                    const color = colorMap[incident.type] || 'gray';
                    L.circleMarker([incident.lat, incident.lon], {
                        radius: 5,
                        fillColor: color,
                        color: color,
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.7
                    }).bindPopup(`<b>${incident.type.replace('_', ' ').toUpperCase()}</b><br>Weight: ${incident.weight}`)
                    .addTo(markerCluster);
                });
                
                map.addLayer(markerCluster);
            }
            
            // Add entities
            if (data.entities) {
                data.entities.forEach(entity => {
                    const icon = entity.type === 'hospital' ? '🏥' : entity.type === 'funeral' ? '⚰️' : '📍';
                    L.marker([entity.lat, entity.lon], {
                        icon: L.divIcon({
                            html: icon,
                            className: 'entity-marker',
                            iconSize: [20, 20]
                        })
                    }).bindPopup(`<b>${entity.name}</b><br>${entity.type}`)
                    .addTo(map);
                });
            }
        }

        function renderHotspots(hotspots) {
            hotspots.forEach(hotspot => {
                const circle = L.circle([hotspot.lat, hotspot.lon], {
                    radius: hotspot.radius,
                    fillColor: hotspot.severity === 'critical' ? '#e74c3c' : hotspot.severity === 'high' ? '#f39c12' : '#f1c40f',
                    color: hotspot.severity === 'critical' ? '#e74c3c' : hotspot.severity === 'high' ? '#f39c12' : '#f1c40f',
                    fillOpacity: 0.3,
                    weight: 3
                });
                
                const popupContent = createHotspotPopup(hotspot);
                circle.bindPopup(popupContent, { maxWidth: 300 });
                circle.addTo(hotspotLayer);
            });
        }

        function createHotspotPopup(hotspot) {
            const crimeDisplay = hotspot.crime_type.replace('_', ' ').toUpperCase();
            
            const popup = $('<div class="hotspot-popup"></div>');
            popup.append(`<div class="hotspot-header">${hotspot.description}</div>`);
            popup.append(`<span class="hotspot-severity severity-${hotspot.severity}">${hotspot.severity.toUpperCase()}</span>`);
            popup.append(`
                <div class="hotspot-stats">
                    <strong>Crime Type:</strong> ${crimeDisplay}<br>
                    <strong>Active Incidents:</strong> ${hotspot.incident_count}<br>
                    <strong>Threat Level:</strong> ${hotspot.total_weight}/100
                </div>
            `);
            
            popup.append('<div style="margin-top: 10px; font-weight: bold;">Targeted Actions (50% cost):</div>');
            
            const actions = [
                { id: 'sweep_hotspot', name: 'Deploy Sweep ($2.5M)', cost: 2.5, pf: 15 },
                { id: 'increase_patrols', name: 'Station Patrol ($1.5M)', cost: 1.5, pf: 8 },
                { id: 'community_policing', name: 'Community Outreach ($1M)', cost: 1, pf: -5 }
            ];
            
            actions.forEach(action => {
                const btn = $(`<button class="hotspot-action-btn">${action.name}</button>`);
                btn.on('click', function(e) {
                    e.stopPropagation();
                    takeHotspotAction(action.id, hotspot.id);
                });
                popup.append(btn);
            });
            
            return popup[0];
        }

        function takeHotspotAction(actionId, hotspotId) {
            const locality = $('#locality').val();
            
            $.ajax({
                url: `/${locality}/hotspot_action`,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ action: actionId, hotspot_id: hotspotId }),
                success: function(data) {
                    if (data.pulse_events && data.pulse_events.length > 0) {
                        data.pulse_events.forEach(text => showPulseEvent(text));
                    }
                    
                    if (data.success) {
                        $('#log').prepend(`<p><strong>Hotspot Action:</strong><br>${data.message}</p>`);
                    } else {
                        $('#log').prepend(`<p style="color: orange;"><strong>Action Failed:</strong><br>${data.message}</p>`);
                    }
                    
                    updateMetricWithAnimation('budget', data.budget, prevMetrics.budget);
                    updateMetricWithAnimation('reputation', data.reputation, prevMetrics.reputation);
                    updateMetricWithAnimation('backlash', data.backlash, prevMetrics.backlash);
                    updateMetricWithAnimation('police-force', data.police_force, prevMetrics.police_force);
                    
                    prevMetrics = {
                        budget: data.budget,
                        reputation: data.reputation,
                        backlash: data.backlash,
                        police_force: data.police_force
                    };
                    
                    updateStabilityProgress(data.reputation, data.backlash, data.budget);
                    updateMap();
                    
                    if (data.triggered_major_event) {
                        handleMajorEvent(data.triggered_major_event);
                    }
                },
                error: function(xhr) {
                    const error = xhr.responseJSON || { error: 'Unknown error' };
                    $('#log').prepend(`<p style="color: red;"><strong>Error:</strong> ${error.error}</p>`);
                }
            });
        }

        function updateMetricWithAnimation(metricId, newValue, oldValue) {
            const element = $(`#${metricId}`);
            const change = newValue - oldValue;
            
            element.text(newValue.toFixed(1));
            
            if (Math.abs(change) > 0.1) {
                const changeClass = change > 0 ? 'metric-increase' : 'metric-decrease';
                const arrow = change > 0 ? '▲' : '▼';
                const color = change > 0 ? '#27ae60' : '#e74c3c';
                
                element.addClass(changeClass);
                element.parent().find('.change-indicator').remove();
                
                const indicator = $('<span class="change-indicator"></span>')
                    .text(`${arrow} ${Math.abs(change).toFixed(1)}`)
                    .css('color', color);
                element.after(indicator);
                
                setTimeout(() => element.removeClass(changeClass), 800);
            }
        }

        function updateStabilityProgress(reputation, backlash, budget) {
            if (reputation > 80 && backlash < 10 && budget > 0) {
                stabilityTurns++;
            } else {
                stabilityTurns = 0;
            }
            
            $('#stability-turns').text(stabilityTurns);
            const percentage = (stabilityTurns / 12) * 100;
            $('#stability-progress')
                .css('width', `${percentage}%`)
                .text(stabilityTurns > 0 ? `${stabilityTurns}/12` : '');
            
            if (stabilityTurns >= 8) {
                $('#win-progress').css('background', '#fff9c4');
                $('#win-progress h4').css('color', '#f39c12');
            } else {
                $('#win-progress').css('background', '#e8f5e9');
                $('#win-progress h4').css('color', '#27ae60');
            }
        }
        
        function handleGameOver(state, message) {
            $('#game-over-title').text((state === 'win_golden_age') ? 'Victory!' : 'Game Over');
            $('#game-over-message').text(message);
            $('#game-over-modal').css('display', 'flex');
            $('#right-sidebar button').prop('disabled', true);
        }

        function handleMajorEvent(event) {
            const modal = $('#event-modal');
            modal.find('#event-title').text(event.name);
            modal.find('#event-text').text(event.text);
            
            const choicesContainer = modal.find('#event-choices').empty();
            event.choices.forEach(choice => {
                const button = $('<button></button>')
                    .text(choice.text)
                    .on('click', function() {
                        respondToEvent(event.name, choice.id);
                        modal.hide();
                        $('#right-sidebar button').prop('disabled', false);
                    });
                choicesContainer.append(button);
            });
            
            modal.css('display', 'flex');
            $('#right-sidebar button').prop('disabled', true);
        }

        function respondToEvent(eventName, choiceId) {
            const payload = { event_response: { name: eventName, choice_id: choiceId } };
            $.ajax({
                url: `/${$('#locality').val()}/action`,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: handleSuccess,
                error: handleError
            });
        }
        
        const handleSuccess = function(data) {
            if (data.pulse_events) {
                data.pulse_events.forEach(text => showPulseEvent(text));
            }
            
            if (data.action_outcomes && data.action_outcomes.length > 0) {
                const actionName = data.action_name || 'Action Taken';
                $('#log').prepend(
                    `<p><strong>${actionName}:</strong><br>${data.action_outcomes.join('<br>')}</p>`
                );
            }
            
            updateMetricWithAnimation('budget', data.budget, prevMetrics.budget);
            updateMetricWithAnimation('reputation', data.reputation, prevMetrics.reputation);
            updateMetricWithAnimation('backlash', data.backlash, prevMetrics.backlash);
            
            if (data.police_force !== undefined) {
                updateMetricWithAnimation('police-force', data.police_force, prevMetrics.police_force);
            }
            
            prevMetrics = {
                budget: data.budget,
                reputation: data.reputation,
                backlash: data.backlash,
                police_force: data.police_force !== undefined ? data.police_force : prevMetrics.police_force
            };
            
            updateStabilityProgress(data.reputation, data.backlash, data.budget);
            updateMap();
            
            if (data.game_over_state && data.game_over_state !== 'active') {
                handleGameOver(data.game_over_state, data.game_over_message);
            } else if (data.triggered_major_event) {
                handleMajorEvent(data.triggered_major_event);
            }
        };
        
        const handleError = function(err) {
            $('#log').prepend(`<p style="color:red;"><strong>Error:</strong> Could not perform action.</p>`);
            console.error(err);
        };

        function takeAction(action) {
            $.ajax({
                url: `/${$('#locality').val()}/action`,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ action: action }),
                success: handleSuccess,
                error: handleError
            });
        }

        function resetGame() {
            const confirmReset = $('#game-over-modal').css('display') === 'flex' ? 
                true : 
                confirm("Are you sure you want to reset? All progress will be lost.");
            
            if (confirmReset) {
                $.ajax({
                    url: '/reset',
                    type: 'POST',
                    success: function(response) { 
                        stabilityTurns = 0;
                        localStorage.removeItem('tutorial_completed');
                        window.location.reload(); 
                    },
                    error: function(xhr, status, error) { 
                        alert('Failed to reset the game: ' + error); 
                    }
                });
            }
        }

        $(document).ready(function() {
            const tutorialCompleted = localStorage.getItem('tutorial_completed');
            
            if (!tutorialCompleted || tutorialCompleted === 'false' || tutorialCompleted === 'null') {
                $('#tutorial-modal').css('display', 'flex');
            }
            
            initMap();
            $('#locality, #crime-type-filter, input[name="view_type"]').on('change', updateMap);
            
            $('#log-toggle').on('click', function() {
                $('#log-slideout').toggleClass('open');
                const isOpen = $('#log-slideout').hasClass('open');
                $(this).text(isOpen ? '✕ Close Log' : '📋 Action Log');
            });
            
            $('#tutorial-next').on('click', function() {
                if (currentTutorialPage === totalTutorialPages) {
                    closeTutorial();
                } else {
                    changeTutorialPage(1);
                }
            });
            
            $('#tutorial-prev').on('click', function() {
                changeTutorialPage(-1);
            });
            
            $('#tutorial-skip').on('click', function() {
                closeTutorial();
            });
        });
    </script>
</body>
</html>
